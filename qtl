# Analysing using R/qtl:

# You need individuals typed at markers, with phenotype data. 

library(qtl)

# To get the tutorial code do: 
url.show("https://rqtl.org/rqtltour.R")

# Within the tutorial is some hypertension data - 250 male mice, with a single hypertension phenotype and 174 genetic markers.
# To get the tutorial data do:
data(hyper)
ls()
# To learn about the data do:
?hyper
summary(hyper)
nind(hyper)
nphe(hyper)
nchr(hyper)
totmar(hyper)
nmar(hyper)
# In the plot below, missing data is coloured black. 
plot(hyper)
# Or, you can plot just one piece of the data:
plotMissing(hyper)
plotMap(hyper)
# There is one phenotype - hypertension value, but there is a second 'pheno' indicating that individuals are male:
plotPheno(hyper, pheno.col=1)
plotPheno(hyper, pheno.col=2)
plotMap(hyper, chr=c(1, 4, 6, 7, 15), show.marker.names=TRUE)

# You can order individuals by phenotype:
plotMissing(hyper, reorder=TRUE)

# You can remove markers with no data in any individual (i.e. not a single individual has data):
hyper <- drop.nullmarkers(hyper)
totmar(hyper)

# Estimate recombination fractions between all pairs of markers, and plot them. 
# This also calculates LOD scores for the test of H0: r = 1/2. 
# The plot of the recombination fractions can be either with recombination fractions in the upper part
# and LOD scores below, or with just recombination fractions or just LOD scores. 
# Red corresponds to a small recombination fraction or a big LOD score
# Blue corresponds to a large recombination fraction (rarely inherited together) and a low LOD score.
# Gray indicates missing values.
hyper <- est.rf(hyper)
plotRF(hyper)
plotRF(hyper, chr=c(1,4), mark.diagonal=T, alternate.chrid=T, chr=c(1,4,15), what="lod")
# Note that what can be "rf" or "lod" or "both", by default both are plotted - with rf above and lod below. 

# Re-estimate the genetic map (keeping the order of markers fixed), and plot the original map against the newly estimated
# one.
newmap <- est.map(hyper, error.prob=0.01)
plotMap(hyper, newmap)

# Do you want to replace with the new estimated map? Think carefully about this... 
# If you do, then you can do it with: 
# hyper <- replace.map(hyper, newmap)

# We now turn to the identification of genotyping errors. In the following, we calculate the error LOD scores of Lincoln
# and Lander (1992). A LOD score is calculated for each individual at each marker; large scores indicate likely genotyping
# errors.
hyper <- calc.errorlod(hyper, error.prob=0.01)
# This calculates the genotype error LOD scores and inserts them into the hyper object.
# The function top.errorlod gives a list of genotypes that may be in error. Error LOD scores < 4 can probably be
# ignored.
top.errorlod(hyper)

# The function plotGeno may be used to inspect the observed genotypes for a chromosome, with likely genotyping errors
# flagged. Of course, itâ€™s difficult to look at too many individuals at once. Note that white = AA and black = AB (for a
# backcross).
plotGeno(hyper, chr=16, ind=c(24:34, 71:81))
# Blue cross suggests a recombination breakpoint.
# Errors are shown using a red box outline.
# It looks like, in this dataset, that it has suggested errors where there is a low chance of recombination, yet the individual 
# has appraently experienced recombination there. But then has experienced it AGAIN on the other side.... 
# Any errors identified need to be checked in the raw data (not in qtl program).

# The function plotInfo plots a measure of the proportion of missing genotype information in the genotype data. The
# missing information is calculated in two ways: as entropy, or via the variance of the conditional genotypes, given the
# observed marker data. (See the help file, using ?plotInfo.)
# NOTE - not quite sure what this is. 
plotInfo(hyper)
plotInfo(hyper, chr=c(1,4,15))
plotInfo(hyper, chr=c(1,4,15), method="entropy")
plotInfo(hyper, chr=c(1,4,15), method="variance")

### QTL analysis:

# R/qtl uses hidden Markov model (HMM) technology to calculate QTL genotype probabilities.
# They simulate from the joint genotype distribution and calculate the most likely sequence of underlying genotypes (I assume for
# the phenotype) - based on the observed genotypes in the data.
# It allows for some error of genotyping.
# Note, they assume, for convenience, no 'crossover interference' - crossover interference was a phrase coined by Muller which 
# states that during meiosis, recombination events don't occur more than once on a chromosome - or at least that they are prevented 
# from occuring close together. This seems to be regulated in C. elegans by the enzyme RTEL-1. Mutants for this enzyme have inc.
# crossovers during meiosis. Recombination rate in humans increases as the female ages. 

# step = the stepsize (in cM) at which probabilities are calculated, and at which LOD scores will later be calculated.
# 1cM = Recombination of 1%
# Note that recombination cannot exceed 50%(?) but the map length (in cM) can - providing you have enough markers - so if you only
# have 2, I think it can't be longer than 50 cM, but if you have several then you might identify that between two markers there is a 
# cM distance of, say, 20, between one of these and another is, say 34 cM, and then between a third is, say, 15 cM - so total is
# 20+34+15 = 69cM..... (https://biology.stackexchange.com/questions/35803/genetic-linkage-greater-than-50-centimorgans). We cannot tell
# whether unlinked markers are co-segregating 50% of the time or linked markers are inherited together 50% of the time - the
# recombination rate, r, is a value between 0 and 0.5. 

# To calculate genotype probabilities, based on the observed markers:
hyper <- calc.genoprob(hyper, step=1, error.prob=0.01)

# To perform a single-QTL (a single QTL controls the phenotype I think) genome scan with a normal model:
# Note that the model chosen (default normal) relates to the phenotype data - can have normal, binary, two-part (not sure what this is
# for), or non-parametric. 
# The method determines the way to estimate the genotypes
# maximum likelihood via the EM algorithm (Lander and Botstein 1989) or use Haley-Knott regression (Haley and Knott
# 1992).
# multiple imputation method of Sen and Churchill (2001). This requires that we first use sim.geno
# to simulate from the joint genotype distribution, given the observed marker data.
# n.draws indicates the number of imputations to perform. Larger values = inc. precision but takes more time and memory.
out.em <- scanone(hyper)
out.hk <- scanone(hyper, method="hk")
hyper <- sim.geno(hyper, step=2, n.draws=16, error.prob=0.01)
out.imp <- scanone(hyper, method="imp")

summary(out.em)
# Gives the max LOD score and position on each chromosome.
summary(out.em, threshold=3)
#         chr  pos  lod
#c1.loc89   1 92.3 3.73
#D4Mit164   4 37.3 8.06
summary(out.hk, threshold=3)
#         chr  pos  lod
#c1.loc89   1 92.3 3.76
#D4Mit164   4 37.3 8.09
summary(out.imp, threshold=3)
#         chr  pos  lod
#c1.loc92   1 95.3 3.62
#D4Mit164   4 37.3 8.07

## Note that imp has pulled out a different marker on Chr1 to the other two.

# Or, could get just the highest LOD score on each chromosome:
max(out.em)
max(out.hk)
max(out.imp)

# I then tried to look at Chr4 with just some individuals - aiming for those of the extreme - but unable to figure out 
# how to determine which individual had which phenotype.
# The order by phenotype for plot missing was great, but doesn't actually correspond to an individuals number.
# Those with the extreme phenotypes are inviduals 1-~100 in the cross object, but don't know which is which.
plotGeno(hyper, chr=4, ind=c(1:100))
# This lets you see that there is a split in the genotypes, but not how they fit the phenotype. 










